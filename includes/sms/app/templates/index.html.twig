<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <title>dashboard</title>
        <!--    bootstrap3 css-->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
        <!--    jquery 3.3-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <!--    bootstrap3 js-->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

        <script type="text/javascript">
            function isJSON(str) {
                if (typeof str == 'string') {
                    try {
                        var obj=JSON.parse(str);
                        if(typeof obj == 'object' && obj ){
                            return true;
                        }else{
                            return false;
                        }

                    } catch(e) {
                        console.log('errorï¼š'+str+'!!!'+e);
                        return false;
                    }
                }
                console.log('It is not a string!')
            }
            function logout() {
                $.ajax({
                    url: '{{ base_url }}/api/logout',
                    success: function(data) {
                        window.location = '{{ base_url }}';
                    }
                });
            }

            function refreshDataFromEE() {
                $("#refresh_data").button('loading');
                $.ajax({
                    url: '{{ base_url }}/api/sms/refresh',
                    success: function(data) {
                        if(data.sc === 200 && data.has_new === true) {
                            window.location = '{{ base_url }}/'; // refresh page
                        } else {
                            alert('No new SMS!');
                        }
                    },
                    complete: function (data) {
                        $("#refresh_data").button('reset');
                    }
                });
            }
        </script>
    </head>
    <body>
        <div class="container">
            <nav class="navbar navbar-default">
                <div class="container-fluid">
                    <div class="navbar-header">
                        <a class="navbar-brand" href="#">SMS Dashboard</a>
                    </div>
                    <div class="collapse navbar-collapse">
                        {% if isLogin  %}
                            <button class="btn btn-default navbar-btn navbar-right" onclick="logout()">Logout</button>
                            <p class="navbar-text navbar-right"></p>
                            <p class="navbar-text navbar-right">Hello <?php echo $username ?>!</p>
                        {% else %}
                            <a type="button" class="btn btn-primary navbar-btn navbar-right" href="{{ base_url }}/login">Login</a>
                        {% endif %}
                    </div>
                </div>
            </nav>

            <div class="col-12">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        SMS Dashboard
                    </div>
                    <div class="panel-body">
                        {% if isLogin  %}
                            <div style="margin-bottom: 16px;">
                                <form id="form_prefix" class="form-inline">
                                    <input type="button" id="refresh_data" onclick="refreshDataFromEE()" class="btn btn-primary" value="Fetch new SMS from EE">
                                    <input type="button" onclick="refresh_sms_table(false)" id="fetch_sms_list_without_prefix" class="btn btn-default" value="Get SMS list">
                                    <div class="form-group">
                                        <label for="sms_prefix">Group Id</label>
                                        <input type="text" class="form-control" id="sms_prefix" placeholder="Group Id">
                                    </div>
                                    <input type="button" onclick="refresh_sms_table(true)" id="fetch_sms_list_with_prefix" class="btn btn-default" value="Get SMS list with prefix">
                                </form>
                            </div>
                            <table class="table table-striped" id="sms-table">
                                <tr>
                                    <th>#</th>
                                    <th>source_msisdn</th>
                                    <th>destination_msisdn</th>
                                    <th>received_time</th>
                                    <th>message</th>
                                </tr>
                            </table>
                            <script type="text/javascript">
                                function refresh_sms_table(check_prefix) {
                                    prefix = $("#sms_prefix").val();
                                    refresh_sms_url = check_prefix && prefix != '' ? '{{ base_url }}/api/sms/list/self/0/1000/' + prefix : '{{ base_url }}/api/sms/list/0/1000';
                                    $("#sms-table").html('<table class="table table-striped" id="sms-table">' +
                                        '<tr>' +
                                        '<th>#</th>' +
                                        '<th>source_msisdn</th>' +
                                        '<th>destination_msisdn</th>' +
                                        '<th>received_time</th>' +
                                        '<th>message</th>' +
                                        '</tr>' +
                                        '</table>');
                                    $.ajax({
                                        url: refresh_sms_url, // first page and 100 rows per page
                                        success : function (data) {
                                            if(data.sc !== 200) {
                                                alert("Get sms list error");
                                            } else {
                                                data.data.forEach(function (item, index) {
                                                    if(isJSON(item.message)) {
                                                        jsonMsg = JSON.parse(item.message);
                                                        str = jsonMsg['s1'] + " " +
                                                            jsonMsg['s2'] + " " +
                                                            jsonMsg['s3'] + " " +
                                                            jsonMsg['s4'] + " " +
                                                            jsonMsg['fan'] + " " +
                                                            jsonMsg['temp'] + " " +
                                                            jsonMsg['keypad'];
                                                        item.message = str;
                                                    }
                                                    $("#sms-table").append(
                                                        "<tr>" +
                                                        "<th>" + item.id + "</th>" +
                                                        "<th>" + item.src_msisdn + "</th>" +
                                                        "<th>" + item.dest_msisdn + "</th>" +
                                                        "<th>" + item.recv_time + "</th>" +
                                                        "<th>" + item.message + "</th>" +
                                                        "</tr>"
                                                    );
                                                });
                                            }
                                        },
                                        error : function (req, status, error) {
                                            console.error(req);
                                            console.error(status);
                                            console.error(error);
                                            alert("Get sms list error");
                                        }
                                    });
                                }
                                refresh_sms_table(true);
                            </script>
                        {% else %}
                            <a type="button" class="btn btn-primary" href="{{ base_url }}/login">Please Login</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
